-- Copyright (c) 2022 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved.
-- SPDX-License-Identifier: Apache-2.0

module Daml.Finance.Util.Test.Date.DayCount where

import DA.Assert
import DA.Date as D
import DA.List
import Daml.Finance.Util.Date.DayCount
import Daml.Finance.Interface.Types.Date.DayCount
import Daml.Finance.Interface.Types.Date.RollConvention
import Daml.Finance.Interface.Types.Date.Schedule
import Daml.Script

testDcfCalculation : Script ()
testDcfCalculation = do

  -- yearly periods
  let
    d1 = date 2022 Feb 23
    d2 = date 2023 Feb 23
    d3 = date 2026 Feb 23

  calcDcf Act360 d1 d2 === 1.0138888889
  calcDcf Act365_Fixed d1 d2 === 1.0
  calcDcf Act365L d1 d2 === 1.0
  calcDcf Basis_1_1 d1 d2 === 1.0
  calcDcf Basis_30360 d1 d2 === 1.0
  calcDcf Basis_30360_ICMA d1 d2 === 1.0
  calcDcf Basis_30E3360 d1 d2 === 1.0

  calcDcf Act365_Fixed d1 d3 === 4.002739726
  calcDcf Act365L d1 d3 === 4.002739726
  calcDcf Basis_30360 d1 d3 === 4.0
  calcDcf Basis_30E3360 d1 d3 === 4.0

  -- from the 30th to the 31st
  let
    d4 = date 2022 Apr 30
    d5 = date 2022 Jul 31

  calcDcf Act365_Fixed d4 d5 === 0.2520547945
  calcDcf Act365L d4 d5 === 0.2520547945
  calcDcf Basis_1_1 d4 d5 === 1.0
  calcDcf Basis_30360 d4 d5 === 0.25
  calcDcf Basis_30360_ICMA d4 d5 === 0.25
  calcDcf Basis_30E3360 d4 d5 === 0.25

  -- from the 31st to the 31st
  let
    d6 = date 2022 May 31
    d7 = date 2022 Aug 31

  calcDcf Basis_30360 d6 d7 === 0.25
  calcDcf Basis_30360_ICMA d6 d7 === 0.25
  calcDcf Basis_30E3360 d6 d7 === 0.25

  -- from the 30th to the 30th
  let
    d8 = date 2022 Apr 30
    d9 = date 2022 Jul 30

  calcDcf Basis_30360 d8 d9 === 0.25
  calcDcf Basis_30360_ICMA d8 d9 === 0.25
  calcDcf Basis_30E3360 d8 d9 === 0.25

  -- from the 31st to the 30th
  let
    d10 = date 2022 Mar 31
    d11 = date 2022 Sep 30

  calcDcf Basis_30360 d10 d11 === 0.5
  calcDcf Basis_30360_ICMA d10 d11 === 0.5
  calcDcf Basis_30E3360 d10 d11 === 0.5

  -- from the 31st to Feb 28th
  let
    d12 = date 2022 Aug 31
    d13 = date 2023 Feb 28

  calcDcf Basis_30360 d12 d13 === 0.4944444444
  calcDcf Basis_30360_ICMA d12 d13 === 0.4944444444
  calcDcf Basis_30E3360 d12 d13 === 0.5

  calcDcf30E360 True d12 d13 === 0.4944444444
    -- ^ test for 30E360 for a product maturing on Feb 28th

  -- from the 30th to Feb 28th
  let
    d14 = date 2022 Aug 30
    d15 = date 2023 Feb 28

  calcDcf Basis_30360 d14 d15 === 0.4944444444
  calcDcf Basis_30360_ICMA d14 d15 === 0.4944444444
  calcDcf Basis_30E3360 d14 d15 === 0.5

  -- from Feb 28th to the 30th
  let
    d16 = date 2022 Feb 28
    d17 = date 2022 Aug 30

  calcDcf Basis_30360 d16 d17 === 0.5055555556
  calcDcf Basis_30360_ICMA d16 d17 === 0.5055555556
  calcDcf Basis_30E3360 d16 d17 === 0.5

  -- from Feb 28th to the 31st
  let
    d18 = date 2022 Feb 28
    d19 = date 2022 Aug 31

  calcDcf Basis_30360 d18 d19 === 0.5083333333
  calcDcf Basis_30360_ICMA d18 d19 === 0.5055555556
  calcDcf Basis_30E3360 d18 d19 === 0.5

  -- from the 31st to Feb 28th of a leap year
  let
    d20 = date 2019 Aug 31
    d21 = date 2020 Feb 28

  calcDcf Act365_Fixed d20 d21 === 0.495890411
  calcDcf Act365L d20 d21 === 0.4945355191
  calcDcf Basis_30360 d20 d21 === 0.4944444444
  calcDcf Basis_30360_ICMA d20 d21 === 0.4944444444
  calcDcf Basis_30E3360 d20 d21 === 0.4944444444

  -- from the 30th to Feb 28th of a leap year
  let
    d22 = date 2019 Aug 30
    d23 = date 2020 Feb 28

  calcDcf Basis_30360 d22 d23 === 0.4944444444
  calcDcf Basis_30360_ICMA d22 d23 === 0.4944444444
  calcDcf Basis_30E3360 d22 d23 === 0.4944444444

  -- from Feb 28th to the 30th of a leap year
  let
    d24 = date 2020 Feb 28
    d25 = date 2020 Aug 30

  calcDcf Basis_30360 d24 d25 === 0.5055555556
  calcDcf Basis_30360_ICMA d24 d25 === 0.5055555556
  calcDcf Basis_30E3360 d24 d25 === 0.5055555556

  -- from Feb 28th to the 31st of a leap year
  let
    d26 = date 2020 Feb 28
    d27 = date 2020 Aug 31

  calcDcf Basis_30360 d26 d27 === 0.5083333333
  calcDcf Basis_30360_ICMA d26 d27 === 0.5055555556
  calcDcf Basis_30E3360 d26 d27 === 0.5055555556

  -- from the 31st to Feb 29th of a leap year
  let
    d28 = date 2019 Aug 31
    d29 = date 2020 Feb 29

  calcDcf Basis_30360 d28 d29 === 0.4972222222
  calcDcf Basis_30360_ICMA d28 d29 === 0.4972222222
  calcDcf Basis_30E3360 d28 d29 === 0.5

  -- from the 30th to Feb 29th of a leap year
  let
    d30 = date 2019 Aug 31
    d31 = date 2020 Feb 29

  calcDcf Basis_30360 d30 d31 === 0.4972222222
  calcDcf Basis_30360_ICMA d30 d31 === 0.4972222222
  calcDcf Basis_30E3360 d30 d31 === 0.5

  -- from Feb 29th to the 30th of a leap year
  let
    d32 = date 2020 Feb 29
    d33 = date 2020 Aug 30

  calcDcf Basis_30360 d32 d33 === 0.5027777778
  calcDcf Basis_30360_ICMA d32 d33 === 0.5027777778
  calcDcf Basis_30E3360 d32 d33 === 0.5

  -- from Feb 29th to the 31st of a leap year
  let
    d34 = date 2020 Feb 29
    d35 = date 2020 Aug 31

  calcDcf Basis_30360 d34 d35 === 0.5055555556
  calcDcf Basis_30360_ICMA d34 d35 === 0.5027777778
  calcDcf Basis_30E3360 d34 d35 === 0.5

  pure ()

-- | Test DCF calculation for a regular period.
testPeriodDcfCalculation_regularPeriod : Script ()
testPeriodDcfCalculation_regularPeriod = do
  let
    period = SchedulePeriod with
      unadjustedStartDate = D.date 2003 Nov 1
      unadjustedEndDate = D.date 2004 May 1
      adjustedStartDate = D.date 2003 Nov 1
      adjustedEndDate = D.date 2004 May 1
      stubType = None
    maturityDate = D.date 2004 May 1
    useAdjustedDatesForDcf = True
    frequency = Frequency with rollConvention = DOM 1; period = M; periodMultiplier = 6
  calcPeriodDcf ActAct_AFB period useAdjustedDatesForDcf maturityDate frequency === 0.4972677596
  calcPeriodDcf ActAct_ISDA period useAdjustedDatesForDcf maturityDate frequency === 0.4977243806
  calcPeriodDcf ActAct_ICMA period useAdjustedDatesForDcf maturityDate frequency === 0.5

-- | Test DCF calculation when there is a short initial stub period.
testPeriodDcfCalculation_shortInitial: Script ()
testPeriodDcfCalculation_shortInitial = do
  let
    periods =
      [ SchedulePeriod with
          unadjustedStartDate = D.date 1999 Feb 1
          unadjustedEndDate = D.date 1999 Jul 1
          adjustedStartDate = D.date 1999 Feb 1
          adjustedEndDate = D.date 1999 Jul 1
          stubType = Some SHORT_INITIAL
      , SchedulePeriod with
          unadjustedStartDate = D.date 1999 Jul 1
          unadjustedEndDate = D.date 2000 Jul 1
          adjustedStartDate = D.date 1999 Jul 1
          adjustedEndDate = D.date 2000 Jul 1
          stubType = None
      ]
    maturityDate = D.date 2000 Jul 1
    useAdjustedDatesForDcf = True
    frequency = Frequency with rollConvention = DOM 1; period = M; periodMultiplier = 12
  calcPeriodDcf ActAct_AFB (periods !! 0) useAdjustedDatesForDcf maturityDate frequency === 0.4109589041
  calcPeriodDcf ActAct_AFB (periods !! 1) useAdjustedDatesForDcf maturityDate frequency === 1.0
  calcPeriodDcf ActAct_ISDA (periods !! 0) useAdjustedDatesForDcf maturityDate frequency === 0.4109589041
  calcPeriodDcf ActAct_ISDA (periods !! 1) useAdjustedDatesForDcf maturityDate frequency === 1.0013773486
  calcPeriodDcf ActAct_ICMA (periods !! 0) useAdjustedDatesForDcf maturityDate frequency === 0.4109589041
  calcPeriodDcf ActAct_ICMA (periods !! 1) useAdjustedDatesForDcf maturityDate frequency === 1.0

-- | Test DCF calculation when there is a long initial stub period.
testPeriodDcfCalculation_longInitial: Script ()
testPeriodDcfCalculation_longInitial = do
  let
    periods =
      [ SchedulePeriod with
          unadjustedStartDate = D.date 2002 Aug 15
          unadjustedEndDate = D.date 2003 Jul 15
          adjustedStartDate = D.date 2002 Aug 15
          adjustedEndDate = D.date 2003 Jul 15
          stubType = Some LONG_INITIAL
      , SchedulePeriod with
          unadjustedStartDate = D.date 2003 Jul 15
          unadjustedEndDate = D.date 2004 Jan 15
          adjustedStartDate = D.date 2003 Jul 15
          adjustedEndDate = D.date 2004 Jan 15
          stubType = None
      ]
    maturityDate = D.date 2004 Jan 15
    useAdjustedDatesForDcf = True
    frequency = Frequency with rollConvention = DOM 15; period = M; periodMultiplier = 6
  calcPeriodDcf ActAct_AFB (periods !! 0) useAdjustedDatesForDcf maturityDate frequency === 0.9150684932
  calcPeriodDcf ActAct_AFB (periods !! 1) useAdjustedDatesForDcf maturityDate frequency === 0.504109589
  calcPeriodDcf ActAct_ISDA (periods !! 0) useAdjustedDatesForDcf maturityDate frequency === 0.9150684931
  calcPeriodDcf ActAct_ISDA (periods !! 1) useAdjustedDatesForDcf maturityDate frequency === 0.5040047908 -- Corrected in updated version of the paper: https://www.isda.org/a/pIJEE/The-Actual-Actual-Day-Count-Fraction-1999.pdf
  calcPeriodDcf ActAct_ICMA (periods !! 0) useAdjustedDatesForDcf maturityDate frequency === 0.9157608696
  calcPeriodDcf ActAct_ICMA (periods !! 1) useAdjustedDatesForDcf maturityDate frequency === 0.5

-- | Test DCF calculation when there is a short final stub period.
testPeriodDcfCalculation_shortFinal: Script ()
testPeriodDcfCalculation_shortFinal = do
  let
    periods =
      [ SchedulePeriod with
          unadjustedStartDate = D.date 1999 Jul 30
          unadjustedEndDate = D.date 2000 Jan 30
          adjustedStartDate = D.date 1999 Jul 30
          adjustedEndDate = D.date 2000 Jan 30
          stubType = None
      , SchedulePeriod with
          unadjustedStartDate = D.date 2000 Jan 30
          unadjustedEndDate = D.date 2000 Jun 30
          adjustedStartDate = D.date 2000 Jan 30
          adjustedEndDate = D.date 2000 Jun 30
          stubType = Some SHORT_FINAL
      ]
    maturityDate = D.date 2000 Jun 30
    useAdjustedDatesForDcf = True
    frequency = Frequency with rollConvention = DOM 30; period = M; periodMultiplier = 6
  calcPeriodDcf ActAct_AFB (periods !! 0) useAdjustedDatesForDcf maturityDate frequency === 0.504109589
  calcPeriodDcf ActAct_AFB (periods !! 1) useAdjustedDatesForDcf maturityDate frequency === 0.4153005464
  calcPeriodDcf ActAct_ISDA (periods !! 0) useAdjustedDatesForDcf maturityDate frequency === 0.5038925069
  calcPeriodDcf ActAct_ISDA (periods !! 1) useAdjustedDatesForDcf maturityDate frequency === 0.4153005464
  calcPeriodDcf ActAct_ICMA (periods !! 0) useAdjustedDatesForDcf maturityDate frequency === 0.5
  calcPeriodDcf ActAct_ICMA (periods !! 1) useAdjustedDatesForDcf maturityDate frequency === 0.4175824176

-- | Test DCF calculation when there is a long final stub period.
testPeriodDcfCalculation_longFinal: Script ()
testPeriodDcfCalculation_longFinal = do
  let
    period = SchedulePeriod with
      unadjustedStartDate = D.date 1999 Nov 30
      unadjustedEndDate = D.date 2000 Apr 30
      adjustedStartDate = D.date 1999 Nov 30
      adjustedEndDate = D.date 2000 Apr 30
      stubType = Some LONG_FINAL
    maturityDate = D.date 2000 Apr 30
    useAdjustedDatesForDcf = True
    frequency = Frequency with rollConvention = EOM; period = M; periodMultiplier = 3
  calcPeriodDcf ActAct_AFB period useAdjustedDatesForDcf maturityDate frequency === 0.4153005464
  calcPeriodDcf ActAct_ISDA period useAdjustedDatesForDcf maturityDate frequency === 0.4155400854
  calcPeriodDcf ActAct_ICMA period useAdjustedDatesForDcf maturityDate frequency === 0.4157608696
  calcPeriodDcf Basis_1_1 period useAdjustedDatesForDcf maturityDate frequency === 1.0
