-- Copyright (c) 2023 Digital Asset (Switzerland) GmbH and/or its affiliates. All rights reserved.
-- SPDX-License-Identifier: Apache-2.0

module Daml.Finance.Test.Util.Holding where

import DA.Assert ((===))
import DA.Map (empty)
import Daml.Finance.Interface.Holding.Base qualified as Base (GetView(..), I)
import Daml.Finance.Interface.Holding.Factory (Reference(..))
import Daml.Finance.Interface.Holding.Factory qualified as HoldingFactory (F, toKey)
import Daml.Finance.Interface.Types.Common.Types (HoldingFactoryKey)
import Daml.Finance.Interface.Util.Disclosure qualified as Disclosure (GetView(..), I)
import Daml.Script

-- | Verify that a party is the owner of a holding.
verifyOwnerOfHolding : (HasToInterface a Base.I, HasToInterface a Disclosure.I) =>
  [(Party, ContractId a)] -> Script [()]
verifyOwnerOfHolding l = forA l
  \(owner, holdingCid) -> do
    v <- submit owner do
      exerciseCmd (toInterfaceContractId @Base.I holdingCid) Base.GetView with viewer = owner
    v.account.owner === owner

-- | Verify that a party is the owner of a holding and that the holding has the expected amount.
verifyOwnerAndAmountOfHolding : (HasToInterface a Base.I, HasToInterface a Disclosure.I) =>
  [(Party, Decimal, ContractId a)] -> Script [()]
verifyOwnerAndAmountOfHolding l = forA l
  \(owner, amount, holdingCid) -> do
    v <- submit owner do
      exerciseCmd (toInterfaceContractId @Base.I holdingCid) Base.GetView with viewer = owner
    v.account.owner === owner
    v.amount === amount

-- | Verify that a holding has no observers.
verifyNoObservers : (HasToInterface a Disclosure.I) => [(Party, ContractId a)] -> Script [()]
verifyNoObservers l = forA l
  \(owner, holdingCid) -> do
    v <- submit owner do
      exerciseCmd (toInterfaceContractId @Disclosure.I holdingCid)
        Disclosure.GetView with viewer = owner
    v.observers === empty

-- | Create a holding factory with refernce.
createHoldingFactoryWithReference :
  forall t.
  ( HasAgreement t
  , HasTemplateTypeRep t
  , HasToAnyTemplate t
  , HasFromAnyTemplate t
  , HasToInterface t HoldingFactory.F
  )
  => t -> Script HoldingFactoryKey
createHoldingFactoryWithReference holdingFactory = do
  let
    factory = toInterface @HoldingFactory.F holdingFactory
    factoryView = view factory
  cid <- toInterfaceContractId @HoldingFactory.F <$> submit factoryView.provider do
    createCmd holdingFactory
  submit factoryView.provider do
    createCmd Reference with
      factoryView; cid; observers = (view $ toInterface @Disclosure.I factory).observers
  pure $ HoldingFactory.toKey factoryView
